-- Supabase query. External/Cloud database for external API implementation
-- Drop tables if they exist
DROP TABLE IF EXISTS op_bus_assignments;
DROP TABLE IF EXISTS hr_employees;
-- Drop sequence if it exists
DROP SEQUENCE IF EXISTS assignment_id_seq;
DROP SEQUENCE IF EXISTS employee_id_seq;
-- Drop types if they exist
DO $$
BEGIN
    IF EXISTS (SELECT 1 FROM pg_type WHERE typname = 'bus_route') THEN
        DROP TYPE bus_route;
    END IF;
END$$;
DO $$
BEGIN
    IF EXISTS (SELECT 1 FROM pg_type WHERE typname = 'bus_type') THEN
        DROP TYPE bus_type;
    END IF;
END$$;
DO $$
BEGIN
    IF EXISTS (SELECT 1 FROM pg_type WHERE typname = 'assignment_type') THEN
        DROP TYPE assignment_type;
    END IF;
END$$;
DO $$
BEGIN
    IF EXISTS (SELECT 1 FROM pg_type WHERE typname = 'job_title') THEN
        DROP TYPE job_title;
    END IF;
END$$;
DO $$
BEGIN
    IF EXISTS (SELECT 1 FROM pg_type WHERE typname = 'payment_method') THEN
        DROP TYPE payment_method;
    END IF;
END$$;
-- Create types
CREATE TYPE bus_route AS ENUM ('S. Palay to PITX', 'S. Palay to Divisoria');
CREATE TYPE bus_type AS ENUM ('Airconditioned', 'Ordinary');
CREATE TYPE assignment_type AS ENUM ('Boundary', 'Percentage');
CREATE TYPE job_title AS ENUM ('Driver', 'Conductor', 'Mechanic', 'Manager', 'Secretary');
CREATE TYPE payment_method AS ENUM ('Company Cash', 'Reimbursement');
-- Create sequences
CREATE SEQUENCE assignment_id_seq START WITH 1 INCREMENT BY 1;
CREATE SEQUENCE employee_id_seq START WITH 1 INCREMENT BY 1;
-- Create employee table
CREATE TABLE hr_employees (
    employee_id VARCHAR(10) PRIMARY KEY DEFAULT 'EMP-' || LPAD(nextval('employee_id_seq')::text, 5, '0'),
    name VARCHAR(255) NOT NULL,
    job_title job_title NOT NULL
);
-- Create bus assignments table aligned with operations department structure
CREATE TABLE op_bus_assignments (
    assignment_id VARCHAR(10) PRIMARY KEY DEFAULT 'ASGN-' || LPAD(nextval('assignment_id_seq')::text, 5, '0'),
    bus_route bus_route,
    date_assigned DATE,
    trip_fuel_expense NUMERIC,
    trip_revenue NUMERIC,
    is_expense_recorded BOOLEAN NOT NULL DEFAULT FALSE,
    is_revenue_recorded BOOLEAN NOT NULL DEFAULT FALSE,
    assignment_type assignment_type NOT NULL,
    assignment_value NUMERIC NOT NULL,
    payment_method payment_method NOT NULL,
    driver_name VARCHAR(255),
    conductor_name VARCHAR(255),
    bus_plate_number VARCHAR(255),
    bus_type bus_type
);
-- Insert hr_employees (drivers and conductors from bus assignments + 20 additional hr_employees)
INSERT INTO hr_employees (name, job_title) VALUES
-- Drivers from bus assignments
('Juan Dela Cruz', 'Driver'),
('Maria Lopez', 'Driver'),
('Jose Ramos', 'Driver'),
('Pedro Cruz', 'Driver'),
('Rosa Santos', 'Driver'),
('Luis Martinez', 'Driver'),
('Ana Morales', 'Driver'),
('Carlos Gomez', 'Driver'),
('Martha Diaz', 'Driver'),
('Jorge Reyes', 'Driver'),
('Elena Fernandez', 'Driver'),
('Ricardo Mendoza', 'Driver'),
('Sandra Lopez', 'Driver'),
('Daniel Cruz', 'Driver'),
('Teresa Alvarez', 'Driver'),
-- Conductors from bus assignments
('Pedro Santos', 'Conductor'),
('Carlos Reyes', 'Conductor'),
('Ana Garcia', 'Conductor'),
('Luisa Mendoza', 'Conductor'),
('Miguel Diaz', 'Conductor'),
('Carmen Flores', 'Conductor'),
('Jose Hernandez', 'Conductor'),
('Isabel Torres', 'Conductor'),
('Ramon Cruz', 'Conductor'),
('Sofia Vargas', 'Conductor'),
('Alberto Navarro', 'Conductor'),
('Gloria Santos', 'Conductor'),
('Victor Ramirez', 'Conductor'),
('Laura Guerrero', 'Conductor'),
('Felipe Gonzales', 'Conductor'),
-- Additional 20 hr_employees (mechanics, managers, secretaries)
('Roberto Dela Torre', 'Mechanic'),
('Antonio Villanueva', 'Mechanic'),
('Francisco Bautista', 'Mechanic'),
('Manuel Soriano', 'Mechanic'),
('Rodrigo Pascual', 'Mechanic'),
('Ernesto Domingo', 'Mechanic'),
('Benjamin Aguilar', 'Mechanic'),
('Eduardo Castillo', 'Mechanic'),
('Cristina Valdez', 'Manager'),
('Patricia Romero', 'Manager'),
('Stephanie Jimenez', 'Manager'),
('Michelle Salazar', 'Manager'),
('Angelica Herrera', 'Secretary'),
('Vanessa Ortega', 'Secretary'),
('Jasmine Moreno', 'Secretary'),
('Diana Gutierrez', 'Secretary'),
('Clarissa Medina', 'Secretary'),
('Melissa Ruiz', 'Secretary'),
('Jennifer Castro', 'Secretary'),
('Katherine Perez', 'Secretary');
-- Insert 15 records with dates from January to May 2025 with varied assignment values
INSERT INTO op_bus_assignments (
    bus_route, date_assigned, trip_fuel_expense, trip_revenue, is_expense_recorded, is_revenue_recorded,
    assignment_type, assignment_value, payment_method, driver_name, conductor_name, bus_plate_number, bus_type
) VALUES
-- Boundary assignments with different quotas
('S. Palay to PITX', '2025-01-15', 1500.50, 9500.00, FALSE, FALSE, 'Boundary', 8000.00, 'Reimbursement', 'Juan Dela Cruz', 'Pedro Santos', 'ABC-1234', 'Airconditioned'),
('S. Palay to Divisoria', '2025-01-28', 1350.00, 8200.00, FALSE, FALSE, 'Boundary', 7500.00, 'Reimbursement', 'Maria Lopez', 'Carlos Reyes', 'DEF-5678', 'Airconditioned'),
('S. Palay to PITX', '2025-02-05', 1600.75, 10200.00, FALSE, FALSE, 'Boundary', 9500.00, 'Company Cash', 'Jose Ramos', 'Ana Garcia', 'GHI-9012', 'Airconditioned'),
('S. Palay to Divisoria', '2025-02-19', 1400.00, 7800.00, FALSE, FALSE, 'Boundary', 7000.00, 'Reimbursement', 'Pedro Cruz', 'Luisa Mendoza', 'JKL-3456', 'Airconditioned'),
-- Percentage assignments with different company shares
('S. Palay to PITX', '2025-02-27', 1550.30, 8950.00, FALSE, FALSE, 'Percentage', 0.60, 'Reimbursement', 'Rosa Santos', 'Miguel Diaz', 'MNO-7890', 'Ordinary'),
('S. Palay to Divisoria', '2025-03-08', 1450.20, 9050.00, FALSE, FALSE, 'Percentage', 0.50, 'Company Cash', 'Luis Martinez', 'Carmen Flores', 'PQR-2345', 'Ordinary'),
('S. Palay to PITX', '2025-03-17', 1380.00, 7900.00, FALSE, FALSE, 'Percentage', 0.42, 'Reimbursement', 'Ana Morales', 'Jose Hernandez', 'STU-6789', 'Ordinary'),
('S. Palay to Divisoria', '2025-03-24', 1425.50, 8100.00, FALSE, FALSE, 'Percentage', 0.55, 'Company Cash', 'Carlos Gomez', 'Isabel Torres', 'VWX-1234', 'Ordinary'),
-- Mixed assignment types with various scenarios
('S. Palay to PITX', '2025-03-30', 1475.00, 9950.00, FALSE, FALSE, 'Boundary', 8500.00, 'Reimbursement', 'Martha Diaz', 'Ramon Cruz', 'YZA-5678', 'Ordinary'),
('S. Palay to Divisoria', '2025-04-05', 1490.25, 8150.00, FALSE, FALSE, 'Boundary', 7500.00, 'Company Cash', 'Jorge Reyes', 'Sofia Vargas', 'BCD-9012', 'Airconditioned'),
('S. Palay to PITX', '2025-04-14', 1520.55, 9000.00, FALSE, FALSE, 'Percentage', 0.48, 'Reimbursement', 'Elena Fernandez', 'Alberto Navarro', 'EFG-3456', 'Airconditioned'),
('S. Palay to Divisoria', '2025-04-22', 1405.75, 8100.00, FALSE, FALSE, 'Percentage', 0.65, 'Reimbursement', 'Ricardo Mendoza', 'Gloria Santos', 'HIJ-7890', 'Airconditioned'),
('S. Palay to PITX', '2025-04-29', 1410.00, 9950.00, FALSE, FALSE, 'Boundary', 9000.00, 'Company Cash', 'Sandra Lopez', 'Victor Ramirez', 'KLM-2345', 'Airconditioned'),
('S. Palay to Divisoria', '2025-05-10', 1365.40, 8000.00, FALSE, FALSE, 'Percentage', 0.52, 'Reimbursement', 'Daniel Cruz', 'Laura Guerrero', 'NOP-6789', 'Airconditioned'),
('S. Palay to PITX', '2025-05-19', 1500.00, 10100.00, FALSE, FALSE, 'Boundary', 8500.00, 'Reimbursement', 'Teresa Alvarez', 'Felipe Gonzales', 'QRS-1234', 'Airconditioned');

CREATE POLICY "Enable read access for all users on assignments"
ON public.op_bus_assignments
FOR SELECT
USING (true);

CREATE POLICY "Enable read access for all users"
ON public.hr_employees
FOR SELECT
USING (true);